<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Office Mayhem: –ë–∞–≥–∞—Ç–æ–∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –®—É—Ç–µ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>

    <script type="module">
    // --- Firebase —ñ–º–ø–æ—Ä—Ç–∏ ---
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import {
        getAuth,
        onAuthStateChanged,
        GoogleAuthProvider,
        signInWithPopup,
        signOut,
        signInAnonymously
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import {
        getFirestore,
        doc,
        getDoc,
        setDoc,
        updateDoc,
        onSnapshot,
        collection,
        addDoc,
        deleteDoc
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // --- –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ (Firebase + –≥—Ä–∞) ---
    let app, db, auth;
    let userId = null;
    let userName = "AnonymousPlayer";
    let userProfileRef = null;
    let playerRef = null;
    let roomRef = null;
    let gameRoomId = null;
    let isHost = false;

    // –Ü–≥—Ä–æ–≤—ñ –∫–æ–Ω—Å—Ç–∞–Ω—Ç–∏
    const GRID_SIZE = 5;
    const TILE_SIZE = 100;
    const PLAYER_SIZE = 30;
    const BULLET_SPEED = 10;
    const PLAYER_SPEED = 5;
    const MAX_HP = 100;
    const GAME_DURATION_SECONDS = 90;
    let timeRemaining = GAME_DURATION_SECONDS;

    // –Ü–≥—Ä–æ–≤–∏–π —Å—Ç–∞–Ω
    let players = {};
    let bullets = [];
    let coins = [
        { id: 'coin1', x: 0.5, y: 0.5, collected: false },
        { id: 'coin2', x: 4.5, y: 0.5, collected: false },
        { id: 'coin3', x: 0.5, y: 4.5, collected: false },
        { id: 'coin4', x: 4.5, y: 4.5, collected: false }
    ];
    const obstacles = [
        { x: 1, y: 1, type: 'table' },
        { x: 3, y: 1, type: 'table' },
        { x: 1, y: 3, type: 'table' },
        { x: 3, y: 3, type: 'table' }
    ];

    const inputState = { up:false, down:false, left:false, right:false };

    // Canvas / —Ä–µ–Ω–¥–µ—Ä
    let canvas, ctx;
    let lastUpdateTime = 0;
    const FPS = 60;
    const FRAME_TIME = 1000 / FPS;

    // --- Firebase –∫–æ–Ω—Ñ—ñ–≥ (–∑–∞–ª–∏—à–∞–π —Å–≤–æ—ó –∫–ª—é—á—ñ —Ç—É—Ç) ---
    const firebaseConfig = {
        apiKey: "AIzaSyAqOKy-am1nyiavsIiknhZh2Vyq0crGYHA",
        authDomain: "game-office-406.firebaseapp.com",
        projectId: "game-office-406",
        storageBucket: "game-office-406.firebasestorage.app",
        messagingSenderId: "662530550810",
        appId: "1:662530550810:web:753eccc327843761c035a3",
        measurementId: "G-LYPY42C873"
        };

    // --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase ---
    const initializeFirebase = async () => {
        try {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            // –°–ø—Ä–æ–±—É—î–º–æ –∞–Ω–æ–Ω—ñ–º–Ω–∏–π –≤—Ö—ñ–¥ (—é–∑–µ—Ä –æ—Ç—Ä–∏–º–∞—î uid)
            await signInAnonymously(auth);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    userProfileRef = doc(db, "users", userId, "profile", "data");
                    document.getElementById("user-id-display").textContent = `ID: ${userId}`;
                    document.getElementById("user-id-display").classList.remove("hidden");
                    document.getElementById("auth-status").textContent = `–£–≤—ñ–π—à–æ–≤ —è–∫: ${user.email || "–ì—ñ—Å—Ç—å"}`;
                    document.getElementById("auth-status").classList.remove("text-red-400");
                    document.getElementById("auth-status").classList.add("text-green-400");
                    document.getElementById("game-status").textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞. –ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ –≥—Ä–∏.";
                    document.getElementById("auth-controls").classList.add("hidden");
                    document.getElementById("logout-btn").classList.remove("hidden");

                    // –ó–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –∞–±–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—å:
                    await loadOrCreateUserProfile(user.displayName);
                } else {
                    // –í–∏–π—à–æ–≤
                    userId = null;
                    userName = "AnonymousPlayer";
                    document.getElementById("auth-status").textContent = "–ù–µ —É–≤—ñ–π—à–æ–≤.";
                    document.getElementById("auth-status").classList.remove("text-green-400");
                    document.getElementById("auth-status").classList.add("text-red-400");
                    document.getElementById("auth-controls").classList.remove("hidden");
                    document.getElementById("logout-btn").classList.add("hidden");
                    document.getElementById("user-name-input").value = userName;
                    document.getElementById("game-status").textContent = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤—Ö–æ–¥—É.";
                    resetGameUI();
                }
            });
        } catch (error) {
            console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase:", error);
            document.getElementById("game-status").textContent = `–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${error.message}`;
        }
    };

    // --- –ü—Ä–æ—Ñ—ñ–ª—ñ ---
    const loadOrCreateUserProfile = async (googleName) => {
        if (!userId || !userProfileRef) return;
        try {
            const snap = await getDoc(userProfileRef);
            if (snap.exists()) {
                const data = snap.data();
                userName = data.name || googleName || `Player${Math.floor(Math.random()*900)+100}`;
            } else {
                userName = googleName || `Player${Math.floor(Math.random()*900)+100}`;
                await setDoc(userProfileRef, {
                    name: userName,
                    createdAt: Date.now(),
                    highScore: 0
                });
            }
            document.getElementById("user-name-input").value = userName;
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –ø—Ä–æ—Ñ—ñ–ª—é:", e);
        }
    };

    // --- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è Google ---
    const signInWithGoogle = async () => {
        const provider = new GoogleAuthProvider();
        try {
            await signInWithPopup(auth, provider);
        } catch (e) {
            console.error("Google sign-in error:", e);
            document.getElementById("game-status").textContent = `–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ${e.message}`;
        }
    };

    const handleSignOut = async () => {
        try {
            if (auth) await signOut(auth);
        } catch (e) {
            console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É:", e);
            document.getElementById("game-status").textContent = `–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: ${e.message}`;
        }
    };

    // --- –ö—ñ–º–Ω–∞—Ç–∞ / –≥—Ä–∞–≤–µ—Ü—å ---
    const createGame = async () => {
        if (!userId) { document.getElementById('game-status').textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É."; return; }
        gameRoomId = crypto.randomUUID().substring(0,8);
        isHost = true;

        roomRef = doc(db, 'rooms', gameRoomId); // –ø—Ä–æ—Å—Ç—ñ—à–∏–π —à–ª—è—Ö
        playerRef = doc(db, 'rooms', gameRoomId, 'players', userId);

        const initialPlayerState = {
            id: userId,
            name: userName,
            x: 1 * TILE_SIZE + TILE_SIZE / 2,
            y: 1 * TILE_SIZE + TILE_SIZE / 2,
            hp: MAX_HP,
            score: 0,
            color: `#${Math.floor(Math.random()*16777215).toString(16)}`,
            lastShot: Date.now(),
            isAlive: true,
            isReady: false
        };

        const initialRoomState = {
            hostId: userId,
            gameState: 'lobby',
            coins,
            bullets: [],
            timer: GAME_DURATION_SECONDS,
            lastBulletId: 0,
            updatedAt: Date.now()
        };

        await setDoc(roomRef, initialRoomState);
        await setDoc(playerRef, initialPlayerState);

        document.getElementById('room-id-display').textContent = gameRoomId;
        document.getElementById('start-game-btn').classList.remove('hidden');
        document.getElementById('leave-game-btn').classList.remove('hidden');
        document.getElementById('game-controls').classList.remove('hidden');
        document.getElementById('lobby-controls').classList.add('hidden');
        document.getElementById('name-entry').classList.add('hidden');
        document.getElementById('game-status').textContent = `–°—Ç–≤–æ—Ä–µ–Ω–æ –∫—ñ–º–Ω–∞—Ç—É: ${gameRoomId}. –í–∏ - —Ö–æ—Å—Ç.`;

        listenToRoom();
        if (isHost) listenToBulletQueue();
    };

    const joinGame = async () => {
        if (!userId) { document.getElementById('game-status').textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –≥—Ä–∏."; return; }
        const joinId = document.getElementById('join-room-id').value.trim();
        if (joinId.length !== 8) { document.getElementById('game-status').textContent = "ID –∫—ñ–º–Ω–∞—Ç–∏ –º–∞—î –±—É—Ç–∏ 8 —Å–∏–º–≤–æ–ª—ñ–≤."; return; }

        gameRoomId = joinId;
        roomRef = doc(db, 'rooms', gameRoomId);
        playerRef = doc(db, 'rooms', gameRoomId, 'players', userId);

        const roomSnap = await getDoc(roomRef);
        if (!roomSnap.exists()) { document.getElementById('game-status').textContent = "–ö—ñ–º–Ω–∞—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –∞–±–æ –Ω–µ —ñ—Å–Ω—É—î."; gameRoomId = null; return; }
        const roomData = roomSnap.data();
        if (roomData.gameState !== 'lobby') { document.getElementById('game-status').textContent = "–ì—Ä–∞ –≤–∂–µ —Ä–æ–∑–ø–æ—á–∞—Ç–∞ –≤ —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ."; gameRoomId = null; return; }

        isHost = roomData.hostId === userId;

        const initialPlayerState = {
            id: userId,
            name: userName,
            x: 3 * TILE_SIZE + TILE_SIZE / 2,
            y: 3 * TILE_SIZE + TILE_SIZE / 2,
            hp: MAX_HP,
            score: 0,
            color: `#${Math.floor(Math.random()*16777215).toString(16)}`,
            lastShot: Date.now(),
            isAlive: true,
            isReady: false
        };

        await setDoc(playerRef, initialPlayerState);

        document.getElementById('room-id-display').textContent = gameRoomId;
        document.getElementById('start-game-btn').classList.toggle('hidden', !isHost);
        document.getElementById('leave-game-btn').classList.remove('hidden');
        document.getElementById('game-controls').classList.remove('hidden');
        document.getElementById('lobby-controls').classList.add('hidden');
        document.getElementById('name-entry').classList.add('hidden');
        document.getElementById('game-status').textContent = `–í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏: ${gameRoomId}.`;

        listenToRoom();
    };

    const leaveGame = async () => {
        if (gameRoomId && userId && playerRef) {
            await updateDoc(playerRef, { isAlive: false, left: true, updatedAt: Date.now() });
        }
        resetGameUI();
    };

    const resetGameUI = () => {
        gameRoomId = null;
        isHost = false;
        playerRef = null;
        roomRef = null;
        players = {};
        bullets = [];
        timeRemaining = GAME_DURATION_SECONDS;

        document.getElementById('room-id-display').textContent = '‚Äî';
        document.getElementById('start-game-btn').classList.add('hidden');
        document.getElementById('leave-game-btn').classList.add('hidden');
        document.getElementById('game-controls').classList.add('hidden');
        document.getElementById('lobby-controls').classList.remove('hidden');
        document.getElementById('leaderboard').innerHTML = '';
        document.getElementById('timer-display').textContent = '01:30';
        document.getElementById('ready-toggle-btn').textContent = '–ì–æ—Ç–æ–≤–∏–π (–ù–µ–º–∞—î)';

        draw();
    };

    // --- –°–ª—É—Ö–∞—á—ñ Firestore ---
    let stopListeningPlayers = () => {};
    let stopListeningRoom = () => {};

    const listenToRoom = () => {
        if (!gameRoomId) return;
        stopListeningRoom = onSnapshot(roomRef, (docSnap) => {
            if (docSnap.exists()) {
                const roomData = docSnap.data();
                if (roomData.gameState === 'playing' && isHost) {
                    // host –º–æ–∂–µ —Å—Ç–∞—Ä—Ç—É–≤–∞—Ç–∏ —Ç–∞–π–º–µ—Ä
                    startGameTimer();
                }

                // –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ç–∞–Ω—É –∑ –∫—ñ–º–Ω–∞—Ç–∏
                // —è–∫—â–æ —Ö–æ—Å—Ç –Ω–∞–¥—Å–∏–ª–∞—î coins/bullets/timer
                if (roomData.coins) coins = roomData.coins;
                bullets = roomData.bullets || bullets;
                timeRemaining = roomData.timer || timeRemaining;
                gameState = roomData.gameState || 'lobby';

                const minutes = Math.floor(timeRemaining / 60);
                const seconds = timeRemaining % 60;
                document.getElementById('timer-display').textContent = `${String(minutes).padStart(2,'0')}:${String(seconds).padStart(2,'0')}`;

                if (gameState === 'finished') {
                    document.getElementById('game-status').textContent = '–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.';
                    clearInterval(gameTimerInterval);
                    updateHighScore();
                }
            } else {
                document.getElementById('game-status').textContent = "–ö—ñ–º–Ω–∞—Ç–∞ –≥—Ä–∏ –±—É–ª–∞ –≤–∏–¥–∞–ª–µ–Ω–∞.";
                resetGameUI();
            }
        });

const playersColRef = collection(db, 'rooms', gameRoomId, 'players');

stopListeningPlayers = onSnapshot(playersColRef, (snapshot) => {
    const newPlayers = {};

    snapshot.forEach((doc) => {
        const player = doc.data();
        if (!player.left) {
            newPlayers[player.id] = player;
        }
    });

    players = newPlayers; // ‚Üê –≤–∞–∂–ª–∏–≤–æ, –ü–û–í–ù–ï –û–ù–û–í–õ–ï–ù–ù–Ø
    updateLeaderboard();
    draw();
});
    };

    // --- High score –æ–Ω–æ–≤–ª–µ–Ω–Ω—è ---
    const updateHighScore = async () => {
        if (!userId || !userProfileRef) return;
        const myPlayer = players[userId];
        if (!myPlayer) return;

        try {
            const profileSnap = await getDoc(userProfileRef);
            if (profileSnap.exists()) {
                const currentHigh = profileSnap.data().highScore || 0;
                if (myPlayer.score > currentHigh) {
                    await updateDoc(userProfileRef, { highScore: myPlayer.score, lastPlayed: Date.now() });
                    document.getElementById('game-status').textContent = `–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ù–æ–≤–∏–π High Score: ${myPlayer.score}!`;
                }
            }
        } catch (e) { console.error("Highscore error:", e); }
    };

    // --- –Ü–≥—Ä–æ–≤–∞ –ª–æ–≥—ñ–∫–∞ (—Ä—É—Ö/–∫—É–ª—è/—É–¥–∞—Ä) ---
    const updatePlayerPosition = (delta) => {
        if (!userId) return;
        const player = players[userId];
        if (!player || player.isAlive === false) return;

        // –∞—Å–ø–µ–∫—Ç–∏ —Ä—É—Ö—É - delta –≤ –æ–¥–∏–Ω–∏—Ü—è—Ö FRAME_TIME
        let newX = player.x, newY = player.y;
        if (inputState.up) newY -= PLAYER_SPEED * delta;
        if (inputState.down) newY += PLAYER_SPEED * delta;
        if (inputState.left) newX -= PLAYER_SPEED * delta;
        if (inputState.right) newX += PLAYER_SPEED * delta;

        const halfSize = PLAYER_SIZE / 2;
        newX = Math.max(halfSize, Math.min(GRID_SIZE * TILE_SIZE - halfSize, newX));
        newY = Math.max(halfSize, Math.min(GRID_SIZE * TILE_SIZE - halfSize, newY));

        // –ü—Ä–æ—Å—Ç–µ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –ø–µ—Ä–µ—à–∫–æ–¥–∞–º–∏ (–≤—ñ–¥–∫–∞—Ç)
        for (const obstacle of obstacles) {
            const ox = obstacle.x * TILE_SIZE + TILE_SIZE/2;
            const oy = obstacle.y * TILE_SIZE + TILE_SIZE/2;
            const o_half = TILE_SIZE/2;

            if (
                newX + halfSize > ox - o_half &&
                newX - halfSize < ox + o_half &&
                newY + halfSize > oy - o_half &&
                newY - halfSize < oy + o_half
            ) {
                // –≤—ñ–¥–∫–æ—Ç–∏—Ç–∏ –Ω–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—é –ø–æ–∑–∏—Ü—ñ—é
                newX = player.x;
                newY = player.y;
                break;
            }
        }

        // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∫–æ–ª–µ–∫—Ü—ñ—ó –º–æ–Ω–µ—Ç (host —Ä–æ–±–∏—Ç—å update)
        for (const coin of coins) {
            if (coin.collected) continue;
            const coinX = coin.x * TILE_SIZE;
            const coinY = coin.y * TILE_SIZE;
            if (Math.abs(newX - coinX) < 20 && Math.abs(newY - coinY) < 20) {
                if (isHost) collectCoin(coin.id, userId);
            }
        }

        if (newX !== player.x || newY !== player.y) {
            updateDoc(playerRef, { x: newX, y: newY, updatedAt: Date.now() }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó:", e));
        }
    };

    const handleHit = async (targetId, shooterId) => {
        if (!roomRef) return;
        const targetRef = doc(db, 'rooms', gameRoomId, 'players', targetId);
        const shooterRef = doc(db, 'rooms', gameRoomId, 'players', shooterId);

        const targetSnap = await getDoc(targetRef);
        if (!targetSnap.exists()) return;
        const target = targetSnap.data();
        if (!target.isAlive) return;

        let newHp = target.hp - 10;
        let newIsAlive = true;
        let scoreChange = 0;
        if (newHp <= 0) {
            newHp = 0;
            newIsAlive = false;
            scoreChange = 10;
            setTimeout(async () => {
                await updateDoc(targetRef, { hp: MAX_HP, isAlive: true, x: 1*TILE_SIZE + TILE_SIZE/2, y: 1*TILE_SIZE + TILE_SIZE/2, updatedAt: Date.now() });
            }, 3000);
        } else {
            scoreChange = 1;
        }

        await updateDoc(targetRef, { hp: newHp, isAlive: newIsAlive, updatedAt: Date.now() });
        await updateDoc(shooterRef, { score: (players[shooterId]?.score || 0) + scoreChange, updatedAt: Date.now() });
    };

    const collectCoin = async (coinId, collectorId) => {
        if (!isHost) return;
        const idx = coins.findIndex(c => c.id === coinId);
        if (idx === -1 || coins[idx].collected) return;
        coins[idx].collected = true;

        const collectorRef = doc(db, 'rooms', gameRoomId, 'players', collectorId);
        await updateDoc(collectorRef, { score: (players[collectorId]?.score || 0) + 5, updatedAt: Date.now() });
        await updateDoc(roomRef, { coins, updatedAt: Date.now() });

        // respawn coin after 5s
        setTimeout(async () => {
            if (isHost && gameRoomId) {
                coins[idx].collected = false;
                await updateDoc(roomRef, { coins, updatedAt: Date.now() });
            }
        }, 5000);
    };

    const fireBullet = (targetX, targetY) => {
        const player = players[userId];
        if (!player || !player.isAlive) return;
        const now = Date.now();
        if (now - (player.lastShot || 0) < 300) return;

        const dx = targetX - player.x;
        const dy = targetY - player.y;
        const dist = Math.sqrt(dx*dx + dy*dy) || 1;
        const vx = (dx/dist) * BULLET_SPEED;
        const vy = (dy/dist) * BULLET_SPEED;

        const newBullet = {
            x: player.x, y: player.y, vx, vy, shooterId: userId, id: Math.random().toString(36).substring(2,9), isAlive:true
        };

        bullets.push(newBullet);
        updateDoc(playerRef, { lastShot: now, updatedAt: Date.now() }).catch(e => console.error(e));

        if (!isHost && gameRoomId) {
            // push to queue (so host will process)
            const bulletQueueRef = collection(db, 'rooms', gameRoomId, 'bullet_queue');
            addDoc(bulletQueueRef, newBullet).catch(e => console.error("bullet queue add error:", e));
        }
    };

    const listenToBulletQueue = () => {
        if (!isHost || !gameRoomId) return;
        const bulletQueueRef = collection(db, 'rooms', gameRoomId, 'bullet_queue');
        onSnapshot(bulletQueueRef, (snapshot) => {
            snapshot.docChanges().forEach((change) => {
                if (change.type === "added") {
                    const b = change.doc.data();
                    bullets.push({ ...b, isAlive:true });
                    deleteDoc(change.doc.ref).catch(e => console.error("delete bullet doc error:", e));
                }
            });
        });
    };

    const updateBullets = async () => {
        if (!isHost) return;
        const newBullets = [];
        let hitPlayers = false;
        for (const b of bullets) {
            if (!b.isAlive) continue;
            b.x += b.vx;
            b.y += b.vy;

            // walls
            if (b.x < 0 || b.x > GRID_SIZE*TILE_SIZE || b.y < 0 || b.y > GRID_SIZE*TILE_SIZE) {
                b.isAlive = false; continue;
            }

            // obstacle collision
            let hitObstacle = false;
            for (const obs of obstacles) {
                const ox = obs.x * TILE_SIZE + TILE_SIZE/2;
                const oy = obs.y * TILE_SIZE + TILE_SIZE/2;
                const o_half = TILE_SIZE/2;
                if (b.x > ox - o_half && b.x < ox + o_half && b.y > oy - o_half && b.y < oy + o_half) {
                    b.isAlive = false;
                    hitObstacle = true; break;
                }
            }
            if (hitObstacle) continue;

            // player hit
            for (const id in players) {
                const t = players[id];
                if (!t || !t.isAlive) continue;
                if (t.id === b.shooterId) continue;
                const dist = Math.hypot(b.x - t.x, b.y - t.y);
                if (dist < PLAYER_SIZE/2 + 5) {
                    b.isAlive = false;
                    hitPlayers = true;
                    handleHit(t.id, b.shooterId);
                    break;
                }
            }

            if (b.isAlive) newBullets.push(b);
        }

        bullets = newBullets;
        // –∑–∞–ø–∏—Å—É—î–º–æ –∫—É–ª—å–∫–∏ –Ω–∞–∑–∞–¥ —É –∫—ñ–º–Ω–∞—Ç—É (host authoritative)
        await updateDoc(roomRef, {
            bullets: bullets.map(b => ({ x:b.x,y:b.y,vx:b.vx,vy:b.vy,shooterId:b.shooterId, id:b.id })),
            lastBulletId: (bullets.reduce((m,b)=>Math.max(m,b.id||0),0) || 0) + 1,
            updatedAt: Date.now()
        }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É–ª—å:", e));
    };

    // --- Game loop / draw / HUD / leaderboard ---
    let gameState = 'lobby';
    let gameTimerInterval;

    const startGame = async () => {
        if (!isHost || gameState !== 'lobby') return;
        const allPlayers = Object.values(players);
        if (allPlayers.length < 2 || allPlayers.some(p => !p.isReady)) {
            document.getElementById('game-status').textContent = "–ù–µ –≤—Å—ñ –≥—Ä–∞–≤—Ü—ñ –≥–æ—Ç–æ–≤—ñ –∞–±–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–∞–≤—Ü—ñ–≤ (–ø–æ—Ç—Ä—ñ–±–Ω–æ ‚â•2).";
            return;
        }
        await updateDoc(roomRef, { gameState: 'playing', updatedAt: Date.now() });
        startGameTimer();
        lastUpdateTime = Date.now();
        requestAnimationFrame(gameLoop);
    };

    const startGameTimer = () => {
        if (gameTimerInterval) clearInterval(gameTimerInterval);
        const startTime = Date.now();
        gameTimerInterval = setInterval(async () => {
            const elapsed = Math.floor((Date.now() - startTime)/1000);
            let newTimeRemaining = GAME_DURATION_SECONDS - elapsed;
            if (newTimeRemaining <= 0) {
                newTimeRemaining = 0;
                clearInterval(gameTimerInterval);
                await updateDoc(roomRef, { gameState: 'finished', timer: 0, updatedAt: Date.now() }).catch(()=>{});
            } else {
                await updateDoc(roomRef, { timer: newTimeRemaining, updatedAt: Date.now() }).catch(()=>{});
            }
        }, 1000);
    };

    const gameLoop = () => {
        if (gameState !== 'playing') return;
        const now = Date.now();
        const delta = (now - lastUpdateTime) / FRAME_TIME;
        lastUpdateTime = now;

        updatePlayerPosition(delta);
        if (isHost) updateBullets();
        draw();

        requestAnimationFrame(gameLoop);
    };

    const draw = () => {
        if (!ctx || !canvas) return;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.fillStyle = '#1e1e1e';
        ctx.fillRect(0,0,canvas.width,canvas.height);

        ctx.strokeStyle = '#333';
        for (let i=0;i<=GRID_SIZE;i++){
            ctx.beginPath();
            ctx.moveTo(i*TILE_SIZE,0); ctx.lineTo(i*TILE_SIZE,GRID_SIZE*TILE_SIZE); ctx.stroke();
            ctx.beginPath();
            ctx.moveTo(0,i*TILE_SIZE); ctx.lineTo(GRID_SIZE*TILE_SIZE,i*TILE_SIZE); ctx.stroke();
        }

        // obstacles
        ctx.fillStyle = '#4a5568';
        ctx.strokeStyle = '#cbd5e0';
        obstacles.forEach(o=>{
            const x = o.x * TILE_SIZE;
            const y = o.y * TILE_SIZE;
            ctx.fillRect(x+5,y+5,TILE_SIZE-10,TILE_SIZE-10);
            ctx.strokeRect(x+5,y+5,TILE_SIZE-10,TILE_SIZE-10);
        });

        // coins
        coins.forEach(c=>{
            if (!c.collected) {
                const x = c.x * TILE_SIZE;
                const y = c.y * TILE_SIZE;
                ctx.fillStyle = '#ffc107';
                ctx.beginPath();
                ctx.arc(x,y,10,0,Math.PI*2);
                ctx.fill();
            }
        });

        // players
        for (const id in players) {
            const p = players[id];
            ctx.fillStyle = p.color || '#999';
            ctx.beginPath();
            ctx.arc(p.x,p.y,PLAYER_SIZE/2,0,Math.PI*2);
            ctx.fill();
            ctx.strokeStyle = id === userId ? '#e53e3e' : '#ffffff';
            ctx.lineWidth = 2; ctx.stroke();

            ctx.fillStyle = '#ffffff'; ctx.font = '10px Inter'; ctx.textAlign='center';
            ctx.fillText(p.name, p.x, p.y - PLAYER_SIZE/2 - 5);

            const hpBarW = PLAYER_SIZE; const hpBarH = 4;
            ctx.fillStyle = '#555';
            ctx.fillRect(p.x - hpBarW/2, p.y + PLAYER_SIZE/2 + 5, hpBarW, hpBarH);
            const curW = (p.hp / MAX_HP) * hpBarW;
            ctx.fillStyle = p.hp > 25 ? '#48bb78' : '#e53e3e';
            ctx.fillRect(p.x - hpBarW/2, p.y + PLAYER_SIZE/2 + 5, curW, hpBarH);
        }

        // bullets
        ctx.fillStyle = '#f0f';
        bullets.forEach(b=>{
            if (b.isAlive) {
                ctx.beginPath(); ctx.arc(b.x,b.y,3,0,Math.PI*2); ctx.fill();
            }
        });

        // HUD updates
        const myPlayer = players[userId];
        if (myPlayer) {
            document.getElementById('my-hp').textContent = myPlayer.hp;
            document.getElementById('my-score').textContent = myPlayer.score;
            document.getElementById('my-hp-bar').style.width = `${(myPlayer.hp / MAX_HP) * 100}%`;
            document.getElementById('my-hp-bar').style.backgroundColor = myPlayer.hp > 25 ? '#48bb78' : '#e53e3e';
        }
    };

    const updateLeaderboard = () => {
    const board = document.getElementById('leaderboard');
    board.innerHTML = '';

    const sorted = Object.values(players)
        .filter(p => !p.left)
        .sort((a, b) => b.score - a.score);

    if (sorted.length === 0) {
        board.innerHTML = `<li class="text-gray-500 text-center p-4">–£–≤—ñ–π–¥—ñ—Ç—å —Ç–∞ –ø—Ä–∏—î–¥–Ω–∞–π—Ç–µ—Å—å –¥–æ –≥—Ä–∏.</li>`;
        return;
    }

    // —Ä–µ–Ω–¥–µ—Ä –≥—Ä–∞–≤—Ü—ñ–≤
    sorted.forEach(p => {
        const isMe = p.id === userId;
        const li = document.createElement('li');
        li.className =
            `flex justify-between items-center p-2 rounded-lg text-sm ` +
            `${isMe ? 'bg-indigo-700 font-bold' : 'hover:bg-gray-700'}`;

        li.innerHTML = `
            <div class="flex items-center space-x-2">
                <span class="w-2 h-2 rounded-full" style="background-color: ${p.color};"></span>
                <span class="${p.isAlive ? '' : 'line-through opacity-50'}">${p.name}</span>
                ${isMe ? '<span class="text-xs text-yellow-300">(–í–∏)</span>' : ''}
                ${p.isReady && gameState === 'lobby'
                    ? '<span class="text-green-400 text-xs ml-2">–ì–æ—Ç–æ–≤–∏–π</span>'
                    : ''}
            </div>
            <span>${p.score} pts</span>
        `;

        board.appendChild(li);
    });

    // ---- –î–û–î–ê–ù–û: –ª–æ–≥—ñ–∫–∞ –∫–Ω–æ–ø–∫–∏ "–°—Ç–∞—Ä—Ç –≥—Ä–∏" ----
    if (isHost && gameState === 'lobby') {
        const total = sorted.length;
        const ready = sorted.filter(p => p.isReady && p.isAlive && !p.left).length;

        const btn = document.getElementById("start-game-btn");

        btn.textContent = `–°—Ç–∞—Ä—Ç –≥—Ä–∏ (${ready}/${total})`;

        // –≤–º–∏–∫–∞—î–º–æ –∫–Ω–æ–ø–∫—É —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ:
        // - –º—ñ–Ω—ñ–º—É–º 2 –≥—Ä–∞–≤—Ü—ñ
        // - –≤—Å—ñ –≥–æ—Ç–æ–≤—ñ
        btn.disabled = !(total >= 2 && ready === total);
    }
};

    // --- UI / input handlers ---
    const initCanvas = () => {
        canvas = document.getElementById('gameCanvas');
        canvas.width = GRID_SIZE * TILE_SIZE;
        canvas.height = GRID_SIZE * TILE_SIZE;
        ctx = canvas.getContext('2d');

        canvas.addEventListener('click', (e) => {
            if (gameState !== 'playing' || !players[userId] || !players[userId].isAlive) return;
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const mouseX = (e.clientX - rect.left) * scaleX;
            const mouseY = (e.clientY - rect.top) * scaleY;
            fireBullet(mouseX, mouseY);
        });

        // touch controls (simple)
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            if (e.touches.length > 0) {
                const rect = canvas.getBoundingClientRect();
                const t = e.touches[0];
                const tx = (t.clientX - rect.left) * (canvas.width/rect.width);
                const ty = (t.clientY - rect.top) * (canvas.height/rect.height);
                // simple: touch on left third -> move joystick, otherwise shoot
                if (t.clientX - rect.left < rect.width / 3) {
                    // don't implement full joystick here; keep simple: set input based on quadrant
                    inputState.up = inputState.down = inputState.left = inputState.right = false;
                } else {
                    fireBullet(tx, ty);
                }
            }
        }, { passive:false });

        const handleKey = (event, isDown) => {
            if (document.activeElement.tagName === 'INPUT') return;
            if (!userId) return;
            let handled = true;
            const k = event.key.toUpperCase();
            switch (k) {
                case 'W': case '–¶': case 'ARROWUP': inputState.up = isDown; break;
                case 'S': case '–Ü': case 'ARROWDOWN': inputState.down = isDown; break;
                case 'A': case '–§': case 'ARROWLEFT': inputState.left = isDown; break;
                case 'D': case '–í': case 'ARROWRIGHT': inputState.right = isDown; break;
                default: handled = false;
            }
            if (handled && gameState === 'playing') {
                event.preventDefault();
                if (isDown && !gameTimerInterval) {
                    lastUpdateTime = Date.now();
                    requestAnimationFrame(gameLoop);
                }
            }
        };

        document.addEventListener('keydown', (e)=>handleKey(e,true));
        document.addEventListener('keyup', (e)=>handleKey(e,false));
    };

    const updateUserName = async () => {
        const input = document.getElementById('user-name-input');
        const newName = input.value.trim();
        if (!userId || !userProfileRef) {
            document.getElementById('game-status').textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è.";
            input.value = userName;
            return;
        }
        if (newName && newName.length <= 15) {
            userName = newName;
            await updateDoc(userProfileRef, { name: userName }).catch(e=>console.error(e));
            if (playerRef) await updateDoc(playerRef, { name: userName }).catch(e=>console.error(e));
            document.getElementById('game-status').textContent = `–Ü–º'—è –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: ${userName}`;
        } else {
            document.getElementById('game-status').textContent = "–Ü–º'—è –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 1 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤.";
            input.value = userName;
        }
    };

    const toggleReady = async () => {
        if (!playerRef || !userId) return;
        const myPlayer = players[userId];
        if (!myPlayer) return;
        const newState = !myPlayer.isReady;
        await updateDoc(playerRef, { isReady: newState }).catch(e=>console.error(e));
        document.getElementById('ready-toggle-btn').textContent = newState ? '–ì–æ—Ç–æ–≤–∏–π (–¢–ê–ö)' : '–ì–æ—Ç–æ–≤–∏–π (–ù–µ–º–∞—î)';
    };

    // --- –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è UI —Ç–∞ –∑–∞–ø—É—Å–∫ ---
    window.onload = () => {
        initCanvas();
        initializeFirebase().then(()=>{
            draw();
        });

        document.getElementById('create-game-btn').addEventListener('click', createGame);
        document.getElementById('join-game-btn').addEventListener('click', joinGame);
        document.getElementById('start-game-btn').addEventListener('click', startGame);
        document.getElementById('leave-game-btn').addEventListener('click', leaveGame);
        document.getElementById('user-name-input').addEventListener('blur', updateUserName);
        document.getElementById('user-name-input').addEventListener('keypress',(e)=>{ if (e.key==='Enter') updateUserName(); });
        document.getElementById('ready-toggle-btn').addEventListener('click', toggleReady);
        document.getElementById('google-sign-in-btn').addEventListener('click', signInWithGoogle);
        document.getElementById('logout-btn').addEventListener('click', handleSignOut);

        const resizeCanvas = () => {
            const container = document.getElementById('canvas-container');
            const size = Math.min(container.clientWidth, window.innerHeight - 350);
            canvas.style.width = `${size}px`;
            canvas.style.height = `${size}px`;
        };
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
    };
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        #gameCanvas { background-color: #2d3748; border: 2px solid #4a5568; border-radius: 8px; box-shadow: 0 10px 15px rgba(0,0,0,.5); touch-action:none; max-width:100%; height:auto; }
        .btn { padding:10px 20px; border-radius:8px; font-weight:bold; transition:all .2s; cursor:pointer; box-shadow:0 4px #1a202c; transform:translateY(0); }
        .btn-primary { background-color:#4c51bf; color:#fff; }
        .btn-secondary { background-color:#38a169; color:#fff; }
        .btn-danger { background-color:#e53e3e; color:#fff; }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">
    <header class="w-full max-w-4xl mb-6">
        <h1 class="text-4xl font-extrabold text-indigo-400 text-center">–û—Ñ—ñ—Å–Ω–∏–π –ë—ñ–π: Mayhem üí•</h1>
        <p id="game-status" class="text-sm text-center text-gray-400 mt-2">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...</p>
    </header>

    <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-6">
        <div class="md:col-span-1 space-y-4">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-indigo-300 mb-2">–ú—ñ–π –°—Ç–∞—Ç—É—Å</h2>
                <p id="auth-status" class="text-sm text-red-400 mb-2">–ù–µ —É–≤—ñ–π—à–æ–≤.</p>
                <div class="flex items-center justify-between text-lg">
                    <span>HP:</span>
                    <span id="my-hp" class="font-mono text-green-400">100</span>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-2.5 mt-1">
                    <div id="my-hp-bar" class="h-2.5 rounded-full" style="width:100%; background-color:#48bb78"></div>
                </div>
                <div class="flex items-center justify-between mt-2 text-lg">
                    <span>–†–∞—Ö—É–Ω–æ–∫:</span>
                    <span id="my-score" class="font-mono text-yellow-400">0</span>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    –ö—ñ–º–Ω–∞—Ç–∞: <span id="room-id-display" class="font-mono text-sm"> ‚Äî </span><br>
                    <span id="user-id-display" class="font-mono text-xs hidden"></span>
                </div>
            </div>

            <div id="auth-controls" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3">
                 <button id="google-sign-in-btn" class="btn w-full flex items-center justify-center bg-white text-gray-800 hover:bg-gray-200">
                    –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                 </button>
            </div>
            <button id="logout-btn" class="btn btn-danger w-full hidden">–í–∏–π—Ç–∏ –∑ –ü—Ä–æ—Ñ—ñ–ª—é</button>

            <div id="name-entry" class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <label for="user-name-input" class="block text-sm font-medium text-gray-300 mb-2">–í–∞—à–µ –Ü–≥—Ä–æ–≤–µ –Ü–º'—è (–¥–æ 15 —Å–∏–º–≤.):</label>
                <input type="text" id="user-name-input" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white" maxlength="15" value="AnonymousPlayer">
            </div>

            <div id="lobby-controls" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3">
                <button id="create-game-btn" class="btn btn-secondary w-full">–°—Ç–≤–æ—Ä–∏—Ç–∏ –ù–æ–≤—É –ì—Ä—É</button>
                <div class="flex space-x-2 w-full">
                    <input type="text" id="join-room-id" placeholder="ID –∫—ñ–º–Ω–∞—Ç–∏" class="w-3/5 p-2 rounded bg-gray-700 border border-gray-600 text-white text-center" maxlength="8">
                    <button id="join-game-btn" class="btn btn-primary w-2/5">–ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è</button>
                </div>
            </div>

            <div id="game-controls" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3 hidden">
                <button id="ready-toggle-btn" class="btn btn-secondary w-full">–ì–æ—Ç–æ–≤–∏–π (–ù–µ–º–∞—î)</button>
                <button id="start-game-btn" class="btn btn-primary w-full hidden" disabled>–ì–æ—Ç–æ–≤—ñ: 0/0 (–ü–æ—Ç—Ä—ñ–±–Ω–æ ‚â•2)</button>
                <button id="leave-game-btn" class="btn btn-danger w-full hidden">–í–∏–π—Ç–∏ –∑ –ì—Ä–∏</button>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-sm">
                <h3 class="font-bold text-gray-300 mb-2">–Ø–∫ –ì—Ä–∞—Ç–∏:</h3>
                <ul class="list-disc list-inside space-y-1 text-gray-400">
                    <li>üïπÔ∏è –†—É—Ö: WASD –∞–±–æ –°—Ç—Ä—ñ–ª–∫–∏ (–º–æ–±—ñ–ª—å–Ω–∏–π: —Ç–æ—Ä–∫) </li>
                    <li>üí• –°—Ç—Ä—ñ–ª—å–±–∞: –ö–ª—ñ–∫ –º–∏—à—ñ –∞–±–æ –¥–æ—Ç–∏–∫ (–∑–∞ –º–µ–∂–∞–º–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞)</li>
                    <li>üí∞ –û—á–∫–∏: –ó–±–∏—Ä–∞–π—Ç–µ –º–æ–Ω–µ—Ç–∏ (+5) —Ç–∞ –≤–±–∏–≤–∞–π—Ç–µ —Å—É–ø–µ—Ä–Ω–∏–∫—ñ–≤ (+10)</li>
                    <li>üõ°Ô∏è –°—Ç—ñ–Ω–∏: –ü–µ—Ä–µ—à–∫–æ–¥–∏ –±–ª–æ–∫—É—é—Ç—å —Ä—É—Ö —ñ –ø–æ—Å—Ç—Ä—ñ–ª–∏</li>
                </ul>
            </div>
        </div>

        <div id="canvas-container" class="md:col-span-2 flex justify-center items-center min-h-[400px]">
            <canvas id="gameCanvas" class="w-full aspect-square"></canvas>
        </div>

        <div class="md:col-span-3 lg:col-span-1">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-yellow-400">–¢–∞–±–ª–æ –õ—ñ–¥–µ—Ä—ñ–≤</h2>
                    <div class="text-lg font-mono text-red-400">
                        <span id="timer-display">01:30</span>
                    </div>
                </div>
                <ul id="leaderboard" class="space-y-2">
                    <li class="text-gray-500 text-center p-4">–£–≤—ñ–π–¥—ñ—Ç—å —Ç–∞ –ø—Ä–∏—î–¥–Ω–∞–π—Ç–µ—Å—å –¥–æ –≥—Ä–∏.</li>
                </ul>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-xs text-gray-500 text-center">
        Office Mayhem (v1.3) | –ü–æ—Å—Ç—ñ–π–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ —á–µ—Ä–µ–∑ Google Sign-In —Ç–∞ Google Firestore.
    </footer>
</body>
</html>