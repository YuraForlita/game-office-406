<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Office Mayhem: –ë–∞–≥–∞—Ç–æ–∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏–π –®—É—Ç–µ—Ä</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { 
    getAuth,
    onAuthStateChanged,
    GoogleAuthProvider,
    signInWithPopup,
    signOut,
    signInAnonymously
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { 
    getFirestore,
    doc,
    getDoc,
    setDoc,
    setLogLevel
} from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

// --- –ì–ª–æ–±–∞–ª—å–Ω—ñ Firebase –∑–º—ñ–Ω–Ω—ñ ---
let app, db, auth;
let userId = null;
let userName = "AnonymousPlayer";
let userProfileRef = null;

// --- –ß–∏—Å—Ç–∏–π Firebase Config –±–µ–∑ Canvas ---
const firebaseConfig = {
    apiKey: "AIzaSyAqOKy-am1nyiavsIiknhZh2Vyq0crGYHA",
    authDomain: "game-office-406.firebaseapp.com",
    projectId: "game-office-406",
    storageBucket: "game-office-406.appspot.com",   // <-- –í–∏–ø—Ä–∞–≤–ª–µ–Ω–æ
    messagingSenderId: "662530550810",
    appId: "1:662530550810:web:753eccc327843761c035a3",
    measurementId: "G-LYPY42C873"
};

// --- –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Firebase ---
const initializeFirebase = async () => {
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        auth = getAuth(app);
        setLogLevel("error");

        // –í—Ö–æ–¥–∏–º–æ –∞–Ω–æ–Ω—ñ–º–Ω–æ, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ —É–≤—ñ–π—à–æ–≤
        await signInAnonymously(auth);

        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;

                // –¢–µ–ø–µ—Ä –ø—Ä–æ—Ñ—ñ–ª—ñ –±—É–¥—É—Ç—å –∑–±–µ—Ä—ñ–≥–∞—Ç–∏—Å—è –≤:
                // users/{userId}/profile/data
                userProfileRef = doc(db, "users", userId, "profile", "data");

                document.getElementById("user-id-display").textContent = `ID: ${userId}`;
                document.getElementById("auth-status").textContent = `–£–≤—ñ–π—à–æ–≤ —è–∫: ${user.email || "–ì—ñ—Å—Ç—å"}`;
                document.getElementById("auth-status").classList.add("text-green-400");
                document.getElementById("auth-status").classList.remove("text-red-400");

                document.getElementById("auth-controls").classList.add("hidden");
                document.getElementById("logout-btn").classList.remove("hidden");

                await loadOrCreateUserProfile(user.displayName);
                document.getElementById("game-status").textContent = "–ê–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–∞. –ì–æ—Ç–æ–≤–Ω—ñ—Å—Ç—å –¥–æ –≥—Ä–∏.";
            } else {
                userId = null;
                userName = "AnonymousPlayer";

                document.getElementById("auth-status").textContent = "–ù–µ —É–≤—ñ–π—à–æ–≤.";
                document.getElementById("auth-status").classList.add("text-red-400");
                document.getElementById("auth-status").classList.remove("text-green-400");

                document.getElementById("auth-controls").classList.remove("hidden");
                document.getElementById("logout-btn").classList.add("hidden");

                document.getElementById("user-name-input").value = userName;
                document.getElementById("game-status").textContent = "–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –≤—Ö–æ–¥—É.";

                resetGameUI?.();
            }
        });

    } catch (error) {
        console.error("–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó Firebase:", error);
        document.getElementById("game-status").textContent = `–ü–æ–º–∏–ª–∫–∞ —ñ–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó: ${error.message}`;
    }
};

// --- –°—Ç–≤–æ—Ä–µ–Ω–Ω—è / –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é ---
const loadOrCreateUserProfile = async (googleName) => {
    if (!userId || !userProfileRef) return;

    const snap = await getDoc(userProfileRef);

    if (snap.exists()) {
        const data = snap.data();
        userName = data.name || googleName || `Player${Math.floor(Math.random() * 900) + 100}`;
    } else {
        userName = googleName || `Player${Math.floor(Math.random() * 900) + 100}`;
        await setDoc(userProfileRef, {
            name: userName,
            createdAt: Date.now(),
            highScore: 0,
        });
    }

    document.getElementById("user-name-input").value = userName;
};

// --- –í—Ö—ñ–¥ —á–µ—Ä–µ–∑ Google ---
const signInWithGoogle = async () => {
    const provider = new GoogleAuthProvider();
    try {
        await signInWithPopup(auth, provider);
    } catch (error) {
        console.error("Google login error:", error);
        document.getElementById("game-status").textContent =
            `–ü–æ–º–∏–ª–∫–∞ –≤—Ö–æ–¥—É: ${error.message}`;
    }
};

// --- –í–∏—Ö—ñ–¥ ---
const logoutUser = async () => {
    await signOut(auth);
};

        const handleSignOut = async () => {
             try {
                await signOut(auth);
                // onAuthStateChanged –æ–±—Ä–æ–±–∏—Ç—å –æ–Ω–æ–≤–ª–µ–Ω–Ω—è UI
             } catch (error) {
                console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É:", error);
                document.getElementById('game-status').textContent = `–ü–æ–º–∏–ª–∫–∞ –≤–∏—Ö–æ–¥—É: ${error.message}`;
             }
        };

        // --- –õ–æ–≥—ñ–∫–∞ –ö—ñ–º–Ω–∞—Ç–∏ —Ç–∞ –ì—Ä–∞–≤—Ü—è (–±–µ–∑ –∑–º—ñ–Ω, –æ–∫—Ä—ñ–º –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ userId) ---

        const createGame = async () => {
            if (!userId) {
                 document.getElementById('game-status').textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± —Å—Ç–≤–æ—Ä–∏—Ç–∏ –≥—Ä—É.";
                 return;
            }

            const newRoomId = crypto.randomUUID().substring(0, 8);
            gameRoomId = newRoomId;
            isHost = true;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId);
            playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'players', userId);

            const initialPlayerState = {
                id: userId,
                name: userName,
                x: 1 * TILE_SIZE + TILE_SIZE / 2,
                y: 1 * TILE_SIZE + TILE_SIZE / 2,
                hp: MAX_HP,
                score: 0,
                color: `#${Math.floor(Math.random()*16777215).toString(16)}`,
                lastShot: Date.now(),
                isAlive: true,
                isReady: false
            };

            const initialRoomState = {
                hostId: userId,
                gameState: 'lobby',
                coins: coins,
                bullets: [],
                timer: GAME_DURATION_SECONDS,
                lastBulletId: 0,
                updatedAt: Date.now()
            };

            await setDoc(roomRef, initialRoomState);
            await setDoc(playerRef, initialPlayerState);

            document.getElementById('room-id-display').textContent = gameRoomId;
            document.getElementById('start-game-btn').classList.remove('hidden');
            document.getElementById('leave-game-btn').classList.remove('hidden');
            document.getElementById('game-controls').classList.remove('hidden');
            document.getElementById('lobby-controls').classList.add('hidden');
            document.getElementById('name-entry').classList.add('hidden');
            document.getElementById('game-status').textContent = `–°—Ç–≤–æ—Ä–µ–Ω–æ –∫—ñ–º–Ω–∞—Ç—É: ${gameRoomId}. –í–∏ - —Ö–æ—Å—Ç.`;

            listenToRoom();
        };

        const joinGame = async () => {
            if (!userId) {
                 document.getElementById('game-status').textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –ø—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è –¥–æ –≥—Ä–∏.";
                 return;
            }
            const joinId = document.getElementById('join-room-id').value.trim();
            if (joinId.length !== 8) {
                document.getElementById('game-status').textContent = "ID –∫—ñ–º–Ω–∞—Ç–∏ –º–∞—î –±—É—Ç–∏ 8 —Å–∏–º–≤–æ–ª—ñ–≤.";
                return;
            }
            gameRoomId = joinId;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId);
            playerRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'players', userId);

            const roomSnap = await getDoc(roomRef);
            if (!roomSnap.exists()) {
                document.getElementById('game-status').textContent = "–ö—ñ–º–Ω–∞—Ç–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞ –∞–±–æ –Ω–µ —ñ—Å–Ω—É—î.";
                gameRoomId = null;
                return;
            }

            const roomData = roomSnap.data();
            if (roomData.gameState !== 'lobby') {
                 document.getElementById('game-status').textContent = "–ì—Ä–∞ –≤–∂–µ —Ä–æ–∑–ø–æ—á–∞—Ç–∞ –≤ —Ü—ñ–π –∫—ñ–º–Ω–∞—Ç—ñ.";
                 gameRoomId = null;
                 return;
            }

            isHost = roomData.hostId === userId;

            const initialPlayerState = {
                id: userId,
                name: userName,
                x: 3 * TILE_SIZE + TILE_SIZE / 2,
                y: 3 * TILE_SIZE + TILE_SIZE / 2,
                hp: MAX_HP,
                score: 0,
                color: `#${Math.floor(Math.random()*16777215).toString(16)}`,
                lastShot: Date.now(),
                isAlive: true,
                isReady: false
            };

            await setDoc(playerRef, initialPlayerState);

            document.getElementById('room-id-display').textContent = gameRoomId;
            document.getElementById('start-game-btn').classList.toggle('hidden', !isHost);
            document.getElementById('leave-game-btn').classList.remove('hidden');
            document.getElementById('game-controls').classList.remove('hidden');
            document.getElementById('lobby-controls').classList.add('hidden');
            document.getElementById('name-entry').classList.add('hidden');
            document.getElementById('game-status').textContent = `–í–∏ –ø—Ä–∏—î–¥–Ω–∞–ª–∏—Å—è –¥–æ –∫—ñ–º–Ω–∞—Ç–∏: ${gameRoomId}.`;

            listenToRoom();
        };

        const leaveGame = async () => {
            if (gameRoomId && userId) {
                // –í–∏–¥–∞–ª–∏—Ç–∏ –≥—Ä–∞–≤—Ü—è
                await setDoc(playerRef, { isAlive: false, left: true }, { merge: true });
            }
            resetGameUI();
        };

        const resetGameUI = () => {
            gameRoomId = null;
            isHost = false;
            playerRef = null;
            roomRef = null;
            players = {};
            gameState = 'lobby';
            bullets = [];
            timeRemaining = GAME_DURATION_SECONDS;

            document.getElementById('room-id-display').textContent = '‚Äî';
            document.getElementById('start-game-btn').classList.add('hidden');
            document.getElementById('leave-game-btn').classList.add('hidden');
            document.getElementById('game-controls').classList.add('hidden');
            document.getElementById('lobby-controls').classList.remove('hidden');
            // document.getElementById('name-entry').classList.remove('hidden'); // –ó–∞–ª–∏—à–∞—î–º–æ –ø—Ä–∏—Ö–æ–≤–∞–Ω–∏–º, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —É–≤—ñ–π—à–æ–≤
            document.getElementById('leaderboard').innerHTML = '';
            document.getElementById('timer-display').textContent = '01:30';
            document.getElementById('ready-toggle-btn').textContent = '–ì–æ—Ç–æ–≤–∏–π (–ù–µ–º–∞—î)';

            // –ü—Ä–∏–ø–∏–Ω–∏—Ç–∏ —Å–ª—É—Ö–∞–Ω–Ω—è
            if (typeof stopListeningPlayers === 'function') stopListeningPlayers();
            if (typeof stopListeningRoom === 'function') stopListeningRoom();

            draw();
        };

        // –°–ª—É—Ö–∞—á—ñ –∑–º—ñ–Ω —É Firestore (–ª–æ–≥—ñ–∫–∞ –±–µ–∑ –∑–º—ñ–Ω)
        let stopListeningPlayers = () => {};
        let stopListeningRoom = () => {};

        const listenToRoom = () => {
            if (!gameRoomId) return;
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

            stopListeningRoom = onSnapshot(roomRef, (docSnap) => {
                if (docSnap.exists()) {
                    const roomData = docSnap.data();

                    if (roomData.gameState === 'playing' && gameState !== 'playing' && isHost) {
                        startGameTimer();
                    }

                    gameState = roomData.gameState;
                    coins = roomData.coins || coins;
                    bullets = roomData.bullets || [];
                    timeRemaining = roomData.timer || GAME_DURATION_SECONDS;

                    if (gameState === 'finished') {
                        document.getElementById('game-status').textContent = '–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–∏.';
                        clearInterval(gameTimerInterval);
                        // –û–Ω–æ–≤–ª–µ–Ω–Ω—è high score –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è
                        updateHighScore();
                    }

                    const minutes = Math.floor(timeRemaining / 60);
                    const seconds = timeRemaining % 60;
                    document.getElementById('timer-display').textContent = `${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
                } else {
                    document.getElementById('game-status').textContent = "–ö—ñ–º–Ω–∞—Ç–∞ –≥—Ä–∏ –±—É–ª–∞ –≤–∏–¥–∞–ª–µ–Ω–∞.";
                    resetGameUI();
                }
            });

            const playersColRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'players');
            stopListeningPlayers = onSnapshot(playersColRef, (snapshot) => {
                snapshot.docChanges().forEach((change) => {
                    const player = change.doc.data();
                    if (player.left) {
                        delete players[player.id];
                    } else {
                        players[player.id] = player;
                    }
                });
                updateLeaderboard();
                draw();
                if (isHost && gameState === 'lobby') {
                    checkAllReady();
                }
            });
        };

        // --- –ù–æ–≤–∞ —Ñ—É–Ω–∫—Ü—ñ—è: –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ High Score ---
        const updateHighScore = async () => {
             const myPlayer = players[userId];
             if (!myPlayer || !userProfileRef) return;

             const currentScore = myPlayer.score;

             const profileSnap = await getDoc(userProfileRef);
             if (profileSnap.exists()) {
                 const currentHighScore = profileSnap.data().highScore || 0;
                 if (currentScore > currentHighScore) {
                     await updateDoc(userProfileRef, {
                         highScore: currentScore,
                         lastPlayed: Date.now()
                     });
                     console.log(`–û–Ω–æ–≤–ª–µ–Ω–æ High Score: ${currentScore}`);
                     document.getElementById('game-status').textContent = `–ì—Ä–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! –ù–æ–≤–∏–π High Score: ${currentScore}!`;
                 }
             }
        };

        // --- –§—É–Ω–∫—Ü—ñ—ó –∫–µ—Ä—É–≤–∞–Ω–Ω—è —Ç–∞ –≥—Ä–∏ (–±–µ–∑ –∑–º—ñ–Ω) ---
        const checkAllReady = () => {
            const allPlayers = Object.values(players);
            const readyPlayers = allPlayers.filter(p => p.isReady).length;
            const totalPlayers = allPlayers.length;

            if (totalPlayers >= 2 && readyPlayers === totalPlayers) {
                document.getElementById('start-game-btn').disabled = false;
                document.getElementById('start-game-btn').textContent = "–†–û–ó–ü–û–ß–ê–¢–ò –ë–Ü–ô";
            } else {
                document.getElementById('start-game-btn').disabled = true;
                document.getElementById('start-game-btn').textContent = `–ì–æ—Ç–æ–≤—ñ: ${readyPlayers}/${totalPlayers} (–ü–æ—Ç—Ä—ñ–±–Ω–æ ‚â•2)`;
            }
        };

        const toggleReady = async () => {
            if (!playerRef || !userId) return;
            const myPlayer = players[userId];
            if (myPlayer) {
                const newReadyState = !myPlayer.isReady;
                await updateDoc(playerRef, { isReady: newReadyState });
                document.getElementById('ready-toggle-btn').textContent = newReadyState ? '–ì–æ—Ç–æ–≤–∏–π (–¢–ê–ö)' : '–ì–æ—Ç–æ–≤–∏–π (–ù–µ–º–∞—î)';
            }
        };


        const startGame = async () => {
            if (!isHost || gameState !== 'lobby') return;

            const allPlayers = Object.values(players);
            if (allPlayers.length < 2 || allPlayers.some(p => !p.isReady)) {
                document.getElementById('game-status').textContent = "–ù–µ –≤—Å—ñ –≥—Ä–∞–≤—Ü—ñ –≥–æ—Ç–æ–≤—ñ –∞–±–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –≥—Ä–∞–≤—Ü—ñ–≤ (–ø–æ—Ç—Ä—ñ–±–Ω–æ ‚â•2).";
                return;
            }

            await updateDoc(roomRef, {
                gameState: 'playing',
                updatedAt: Date.now()
            });

            startGameTimer();
            gameLoop();
        };

        let gameTimerInterval;
        const startGameTimer = () => {
            if (gameTimerInterval) clearInterval(gameTimerInterval);
            let startTime = Date.now();

            gameTimerInterval = setInterval(async () => {
                const elapsed = Math.floor((Date.now() - startTime) / 1000);
                let newTimeRemaining = GAME_DURATION_SECONDS - elapsed;

                if (newTimeRemaining <= 0) {
                    newTimeRemaining = 0;
                    clearInterval(gameTimerInterval);
                    await updateDoc(roomRef, { gameState: 'finished', timer: 0, updatedAt: Date.now() });
                }

                if (newTimeRemaining > 0) {
                    await updateDoc(roomRef, { timer: newTimeRemaining, updatedAt: Date.now() });
                }
            }, 1000);
        };

        //... [updatePlayerPosition, updateBullets, handleHit, collectCoin, fireBullet, listenToBulletQueue, gameLoop, draw - –∑–∞–ª–∏—à–∞—é—Ç—å—Å—è –±–µ–∑ –∑–º—ñ–Ω]

        const updatePlayerPosition = (delta) => {
            const player = players[userId];
            if (!player || gameState !== 'playing' || !player.isAlive) return;

            let newX = player.x;
            let newY = player.y;

            // –†–æ–∑—Ä–∞—Ö—É–Ω–æ–∫ —Ä—É—Ö—É
            if (inputState.up) newY -= PLAYER_SPEED * delta;
            if (inputState.down) newY += PLAYER_SPEED * delta;
            if (inputState.left) newX -= PLAYER_SPEED * delta;
            if (inputState.right) newX += PLAYER_SPEED * delta;

            const halfSize = PLAYER_SIZE / 2;

            // –û–±–º–µ–∂–µ–Ω–Ω—è –ø–æ–ª—è (—Å—Ç—ñ–Ω–∫–∏)
            newX = Math.max(halfSize, Math.min(GRID_SIZE * TILE_SIZE - halfSize, newX));
            newY = Math.max(halfSize, Math.min(GRID_SIZE * TILE_SIZE - halfSize, newY));

            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –ø–µ—Ä–µ—à–∫–æ–¥–∞–º–∏
            let collided = false;
            for (const obstacle of obstacles) {
                const ox = obstacle.x * TILE_SIZE + TILE_SIZE / 2;
                const oy = obstacle.y * TILE_SIZE + TILE_SIZE / 2;
                const o_half_size = TILE_SIZE / 2;

                if (
                    newX + halfSize > ox - o_half_size &&
                    newX - halfSize < ox + o_half_size &&
                    newY + halfSize > oy - o_half_size &&
                    newY - halfSize < oy + o_half_size
                ) {
                    collided = true;
                    let testX = player.x;
                    let testY = newY;
                    let blockedY = false;
                    for (const o of obstacles) {
                         const ox_test = o.x * TILE_SIZE + TILE_SIZE / 2;
                         const oy_test = o.y * TILE_SIZE + TILE_SIZE / 2;
                         if (testX + halfSize > ox_test - o_half_size && testX - halfSize < ox_test + o_half_size && testY + halfSize > oy_test - o_half_size && testY - halfSize < oy_test + o_half_size) {
                             blockedY = true;
                             break;
                         }
                    }

                    if (!blockedY) {
                        newX = player.x;
                        newY = testY;
                        collided = false;
                        break;
                    }

                    let testX2 = newX;
                    let testY2 = player.y;
                    let blockedX = false;
                    for (const o of obstacles) {
                         const ox_test = o.x * TILE_SIZE + TILE_SIZE / 2;
                         const oy_test = o.y * TILE_SIZE + TILE_SIZE / 2;
                         if (testX2 + halfSize > ox_test - o_half_size && testX2 - halfSize < ox_test + o_half_size && testY2 + halfSize > oy_test - o_half_size && testY2 - halfSize < oy_test + o_half_size) {
                             blockedX = true;
                             break;
                         }
                    }

                    if (!blockedX) {
                        newX = testX2;
                        newY = player.y;
                        collided = false;
                        break;
                    }

                    newX = player.x;
                    newY = player.y;
                }
            }


            // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –º–æ–Ω–µ—Ç–∞–º–∏
            for (const coin of coins) {
                if (coin.collected) continue;

                const coinX = coin.x * TILE_SIZE;
                const coinY = coin.y * TILE_SIZE;

                if (
                    newX + halfSize > coinX - 10 &&
                    newX - halfSize < coinX + 10 &&
                    newY + halfSize > coinY - 10 &&
                    newY - halfSize < coinY + 10
                ) {
                    if (isHost) {
                        collectCoin(coin.id, userId);
                    }
                }
            }

            if (newX !== player.x || newY !== player.y) {
                updateDoc(playerRef, {
                    x: newX,
                    y: newY,
                    updatedAt: Date.now()
                }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ–∑–∏—Ü—ñ—ó:", e));
            }
        };

        const updateBullets = () => {
            if (!isHost || gameState !== 'playing') return;

            const newBullets = [];
            let hitPlayers = false;

            for (const bullet of bullets) {
                if (!bullet.isAlive) continue;

                bullet.x += bullet.vx;
                bullet.y += bullet.vy;

                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑—ñ —Å—Ç—ñ–Ω–∞–º–∏
                if (
                    bullet.x < 0 || bullet.x > GRID_SIZE * TILE_SIZE ||
                    bullet.y < 0 || bullet.y > GRID_SIZE * TILE_SIZE
                ) {
                    bullet.isAlive = false;
                    continue;
                }

                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –ø–µ—Ä–µ—à–∫–æ–¥–∞–º–∏
                let hitObstacle = false;
                for (const obstacle of obstacles) {
                    const ox = obstacle.x * TILE_SIZE + TILE_SIZE / 2;
                    const oy = obstacle.y * TILE_SIZE + TILE_SIZE / 2;
                    const o_half_size = TILE_SIZE / 2;

                    if (
                        bullet.x > ox - o_half_size && bullet.x < ox + o_half_size &&
                        bullet.y > oy - o_half_size && bullet.y < oy + o_half_size
                    ) {
                        bullet.isAlive = false;
                        hitObstacle = true;
                        break;
                    }
                }
                if (hitObstacle) continue;

                // –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –∑—ñ—Ç–∫–Ω–µ–Ω–Ω—è –∑ –≥—Ä–∞–≤—Ü—è–º–∏
                for (const id in players) {
                    const target = players[id];
                    if (target.id === bullet.shooterId || !target.isAlive) continue;

                    const dist = Math.sqrt(
                        (bullet.x - target.x) ** 2 + (bullet.y - target.y) ** 2
                    );

                    if (dist < PLAYER_SIZE / 2 + 5) {
                        bullet.isAlive = false;
                        hitPlayers = true;

                        handleHit(target.id, bullet.shooterId);
                        break;
                    }
                }

                if (bullet.isAlive) {
                    newBullets.push(bullet);
                }
            }

            if (bullets.length !== newBullets.length || hitPlayers) {
                updateDoc(roomRef, {
                    bullets: newBullets.map(b => ({
                        x: b.x, y: b.y, vx: b.vx, vy: b.vy, shooterId: b.shooterId, id: b.id
                    })),
                    lastBulletId: bullets.reduce((max, b) => Math.max(max, b.id || 0), 0) + 1,
                    updatedAt: Date.now()
                }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∫—É–ª—å:", e));

            }
        };

        const handleHit = async (targetId, shooterId) => {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const targetRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'players', targetId);
            const shooterRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'players', shooterId);

            const targetSnap = await getDoc(targetRef);
            if (!targetSnap.exists()) return;

            const target = targetSnap.data();
            if (!target.isAlive) return;

            let newHp = target.hp - 10;
            let newIsAlive = true;
            let scoreChange = 0;

            if (newHp <= 0) {
                newHp = 0;
                newIsAlive = false;
                scoreChange = 10;
                setTimeout(async () => {
                    await updateDoc(targetRef, {
                        hp: MAX_HP,
                        isAlive: true,
                        x: 1 * TILE_SIZE + TILE_SIZE / 2,
                        y: 1 * TILE_SIZE + TILE_SIZE / 2
                    });
                }, 3000);
            } else {
                scoreChange = 1;
            }

            await updateDoc(targetRef, {
                hp: newHp,
                isAlive: newIsAlive,
                updatedAt: Date.now()
            });

            await updateDoc(shooterRef, {
                score: (players[shooterId].score || 0) + scoreChange,
                updatedAt: Date.now()
            });
        };

        const collectCoin = async (coinId, collectorId) => {
             if (!isHost || gameState !== 'playing') return;

             const coinIndex = coins.findIndex(c => c.id === coinId);
             if (coinIndex === -1 || coins[coinIndex].collected) return;

             coins[coinIndex].collected = true;

             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             const collectorRef = doc(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'players', collectorId);
             await updateDoc(collectorRef, {
                 score: (players[collectorId].score || 0) + 5,
                 updatedAt: Date.now()
             });

             await updateDoc(roomRef, {
                 coins: coins,
                 updatedAt: Date.now()
             });

             setTimeout(async () => {
                 if (isHost && gameRoomId) {
                      coins[coinIndex].collected = false;
                      await updateDoc(roomRef, {
                          coins: coins,
                          updatedAt: Date.now()
                      });
                 }
             }, 5000);
        };


        const fireBullet = (targetX, targetY) => {
            const player = players[userId];
            if (!player || gameState !== 'playing' || !player.isAlive) return;

            const now = Date.now();
            if (now - player.lastShot < 300) return;

            const dx = targetX - player.x;
            const dy = targetY - player.y;
            const dist = Math.sqrt(dx * dx + dy * dy);

            const vx = (dx / dist) * BULLET_SPEED;
            const vy = (dy / dist) * BULLET_SPEED;

            const newBullet = {
                x: player.x,
                y: player.y,
                vx: vx,
                vy: vy,
                shooterId: userId,
                id: (isHost ? bullets.length : 0) + Math.random()
            };

            bullets.push(newBullet);

            updateDoc(playerRef, {
                lastShot: now,
                updatedAt: Date.now()
            }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –ø–æ—Å—Ç—Ä—ñ–ª—É:", e));

            if (!isHost) {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const bulletQueueRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'bullet_queue');
                addDoc(bulletQueueRef, newBullet).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∫—É–ª—ñ –≤ —á–µ—Ä–≥—É:", e));
            }
        };

        const listenToBulletQueue = () => {
             if (!isHost || !gameRoomId) return;
             const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
             const bulletQueueRef = collection(db, 'artifacts', appId, 'public', 'data', 'rooms', gameRoomId, 'bullet_queue');

             onSnapshot(bulletQueueRef, (snapshot) => {
                 snapshot.docChanges().forEach((change) => {
                     if (change.type === "added") {
                         const bulletData = change.doc.data();
                         bullets.push({ ...bulletData, isAlive: true });
                         deleteDoc(change.doc.ref).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –≤–∏–¥–∞–ª–µ–Ω–Ω—è –∫—É–ª—ñ –∑ —á–µ—Ä–≥–∏:", e));
                     }
                 });
             });
        };

        const gameLoop = () => {
            if (gameState !== 'playing') return;

            const now = Date.now();
            const delta = (now - lastUpdateTime) / FRAME_TIME;
            lastUpdateTime = now;

            updatePlayerPosition(delta);

            if (isHost) {
                 updateBullets();
            }

            draw();

            requestAnimationFrame(gameLoop);
        };

        const draw = () => {
            if (!ctx || !canvas) return;

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = '#1e1e1e';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = '#333';
            for (let i = 0; i <= GRID_SIZE; i++) {
                ctx.beginPath();
                ctx.moveTo(i * TILE_SIZE, 0);
                ctx.lineTo(i * TILE_SIZE, GRID_SIZE * TILE_SIZE);
                ctx.stroke();

                ctx.beginPath();
                ctx.moveTo(0, i * TILE_SIZE);
                ctx.lineTo(0, GRID_SIZE * TILE_SIZE);
                ctx.stroke();
            }

            // –ú–∞–ª—é–≤–∞–Ω–Ω—è –ø–µ—Ä–µ—à–∫–æ–¥
            ctx.fillStyle = '#4a5568';
            ctx.strokeStyle = '#cbd5e0';
            obstacles.forEach(obstacle => {
                const x = obstacle.x * TILE_SIZE;
                const y = obstacle.y * TILE_SIZE;
                ctx.fillRect(x + 5, y + 5, TILE_SIZE - 10, TILE_SIZE - 10);
                ctx.strokeRect(x + 5, y + 5, TILE_SIZE - 10, TILE_SIZE - 10);
            });

            // –ú–∞–ª—é–≤–∞–Ω–Ω—è –º–æ–Ω–µ—Ç
            coins.forEach(coin => {
                if (!coin.collected) {
                    const x = coin.x * TILE_SIZE;
                    const y = coin.y * TILE_SIZE;
                    ctx.fillStyle = '#ffc107';
                    ctx.beginPath();
                    ctx.arc(x, y, 10, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // –ú–∞–ª—é–≤–∞–Ω–Ω—è –≥—Ä–∞–≤—Ü—ñ–≤
            for (const id in players) {
                const player = players[id];

                ctx.fillStyle = player.color;
                ctx.beginPath();
                ctx.arc(player.x, player.y, PLAYER_SIZE / 2, 0, Math.PI * 2);
                ctx.fill();
                ctx.strokeStyle = id === userId ? '#e53e3e' : '#ffffff';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.fillStyle = '#ffffff';
                ctx.font = '10px Inter';
                ctx.textAlign = 'center';
                ctx.fillText(player.name, player.x, player.y - PLAYER_SIZE / 2 - 5);

                const hpBarWidth = PLAYER_SIZE;
                const hpBarHeight = 4;
                const hpBarX = player.x - hpBarWidth / 2;
                const hpBarY = player.y + PLAYER_SIZE / 2 + 5;

                ctx.fillStyle = '#555';
                ctx.fillRect(hpBarX, hpBarY, hpBarWidth, hpBarHeight);
                const currentHpWidth = (player.hp / MAX_HP) * hpBarWidth;
                ctx.fillStyle = player.hp > 25 ? '#48bb78' : '#e53e3e';
                ctx.fillRect(hpBarX, hpBarY, currentHpWidth, hpBarHeight);
            }

            // –ú–∞–ª—é–≤–∞–Ω–Ω—è –∫—É–ª—å
            ctx.fillStyle = '#f0f';
            bullets.forEach(bullet => {
                if (bullet.isAlive) {
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
            });

            // –û–Ω–æ–≤–ª–µ–Ω–Ω—è HUD
            const myPlayer = players[userId];
            if (myPlayer) {
                document.getElementById('my-hp').textContent = myPlayer.hp;
                document.getElementById('my-score').textContent = myPlayer.score;
                document.getElementById('my-hp-bar').style.width = `${(myPlayer.hp / MAX_HP) * 100}%`;
                document.getElementById('my-hp-bar').style.backgroundColor = myPlayer.hp > 25 ? '#48bb78' : '#e53e3e';
            }
        };

        const updateLeaderboard = () => {
            const board = document.getElementById('leaderboard');
            board.innerHTML = '';
            const sortedPlayers = Object.values(players)
                .filter(p => !p.left)
                .sort((a, b) => b.score - a.score);

            sortedPlayers.forEach(player => {
                const isMe = player.id === userId;
                const listItem = document.createElement('li');
                listItem.className = `flex justify-between items-center p-2 rounded-lg text-sm transition-colors ${isMe ? 'bg-indigo-700 font-bold' : 'hover:bg-gray-700'}`;
                listItem.innerHTML = `
                    <div class="flex items-center space-x-2">
                        <span class="w-2 h-2 rounded-full" style="background-color: ${player.color};"></span>
                        <span class="${player.isAlive ? '' : 'line-through opacity-50'}">${player.name}</span>
                        ${isMe ? '<span class="text-xs text-yellow-300">(–í–∏)</span>' : ''}
                        ${player.isReady && gameState === 'lobby' ? '<span class="text-green-400 text-xs ml-2">–ì–æ—Ç–æ–≤–∏–π</span>' : ''}
                    </div>
                    <span>${player.score} pts</span>
                `;
                board.appendChild(listItem);
            });
        };


        // --- –û–±—Ä–æ–±–Ω–∏–∫–∏ –ü–æ–¥—ñ–π ---

        const initCanvas = () => {
            canvas = document.getElementById('gameCanvas');
            canvas.width = GRID_SIZE * TILE_SIZE;
            canvas.height = GRID_SIZE * TILE_SIZE;
            ctx = canvas.getContext('2d');

            canvas.addEventListener('click', (e) => {
                if (gameState !== 'playing' || !players[userId] || !players[userId].isAlive) return;

                const rect = canvas.getBoundingClientRect();
                const scaleX = canvas.width / rect.width;
                const scaleY = canvas.height / rect.height;

                const mouseX = (e.clientX - rect.left) * scaleX;
                const mouseY = (e.clientY - rect.top) * scaleY;

                fireBullet(mouseX, mouseY);
            });

            // –û–±—Ä–æ–±–Ω–∏–∫ –¥–æ—Ç–∏–∫—É (–º–æ–±—ñ–ª—å–Ω–∏–π)
            let joystickCenter = { x: 0, y: 0 };
            let joystickActive = false;
            const JOYSTICK_RADIUS = 50;

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                if (e.touches.length > 0) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;

                    if (touchX < rect.width / 3 && touchY > rect.height * 2 / 3) {
                        joystickCenter = { x: touchX, y: touchY };
                        joystickActive = true;
                        handleJoystickMove(touchX, touchY, rect);
                    } else {
                        const scaleX = canvas.width / rect.width;
                        const scaleY = canvas.height / rect.height;

                        const targetX = touchX * scaleX;
                        const targetY = touchY * scaleY;
                        fireBullet(targetX, targetY);
                    }
                }
            }, { passive: false });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                if (joystickActive && e.touches.length > 0) {
                    const rect = canvas.getBoundingClientRect();
                    const touch = e.touches[0];
                    const touchX = touch.clientX - rect.left;
                    const touchY = touch.clientY - rect.top;
                    handleJoystickMove(touchX, touchY, rect);
                }
            }, { passive: false });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                if (joystickActive) {
                    joystickActive = false;
                    inputState.up = inputState.down = inputState.left = inputState.right = false;
                    draw();
                }
            }, { passive: false });


            const handleJoystickMove = (touchX, touchY, rect) => {
                const dx = touchX - joystickCenter.x;
                const dy = touchY - joystickCenter.y;

                const angle = Math.atan2(dy, dx);
                const magnitude = Math.min(Math.sqrt(dx * dx + dy * dy), JOYSTICK_RADIUS);

                inputState.up = Math.cos(angle - Math.PI / 2) * magnitude > 20;
                inputState.down = Math.cos(angle + Math.PI / 2) * magnitude > 20;
                inputState.left = Math.cos(angle - Math.PI) * magnitude > 20;
                inputState.right = Math.cos(angle) * magnitude > 20;
            };

            // –û–±—Ä–æ–±–Ω–∏–∫ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä–∏ (—Ñ—ñ–∫—Å –¥–ª—è —Ä—É—Ö—É)
            const handleKey = (event, isDown) => {
                if (document.activeElement.tagName === 'INPUT') return;
                if (!userId) return; // –†—É—Ö —Ç—ñ–ª—å–∫–∏ –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö

                let handled = true;
                switch (event.key.toUpperCase()) {
                    case 'W':
                    case '–¶':
                    case 'ARROWUP':
                        inputState.up = isDown;
                        break;
                    case 'S':
                    case '–Ü':
                    case 'ARROWDOWN':
                        inputState.down = isDown;
                        break;
                    case 'A':
                    case '–§':
                    case 'ARROWLEFT':
                        inputState.left = isDown;
                        break;
                    case 'D':
                    case '–í':
                    case 'ARROWRIGHT':
                        inputState.right = isDown;
                        break;
                    default:
                        handled = false;
                }

                if (handled && gameState === 'playing') {
                    event.preventDefault();
                    if (isDown && !gameTimerInterval) {
                        lastUpdateTime = Date.now();
                        requestAnimationFrame(gameLoop);
                    }
                }
            };

            document.addEventListener('keydown', (e) => handleKey(e, true));
            document.addEventListener('keyup', (e) => handleKey(e, false));
        };

        const updateUserName = async () => {
             const inputElement = document.getElementById('user-name-input');
             const newName = inputElement.value.trim();
             if (!userId || !userProfileRef) {
                 document.getElementById('game-status').textContent = "–ë—É–¥—å –ª–∞—Å–∫–∞, —É–≤—ñ–π–¥—ñ—Ç—å, —â–æ–± –∑–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è.";
                 inputElement.value = userName;
                 return;
             }

             if (newName && newName.length <= 15) {
                 userName = newName;
                 // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Å—Ç—ñ–π–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é
                 await updateDoc(userProfileRef, { name: userName }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ:", e));

                 // –û–Ω–æ–≤–ª–µ–Ω–Ω—è –ø–æ—Ç–æ—á–Ω–æ–≥–æ –≥—Ä–∞–≤—Ü—è, —è–∫—â–æ –≤—ñ–Ω —É –∫—ñ–º–Ω–∞—Ç—ñ
                 if (playerRef) {
                     updateDoc(playerRef, { name: userName }).catch(e => console.error("–ü–æ–º–∏–ª–∫–∞ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ –≤ –∫—ñ–º–Ω–∞—Ç—ñ:", e));
                 }
                 document.getElementById('game-status').textContent = `–Ü–º'—è –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: ${userName}`;
             } else {
                 document.getElementById('game-status').textContent = "–Ü–º'—è –º–∞—î –±—É—Ç–∏ –≤—ñ–¥ 1 –¥–æ 15 —Å–∏–º–≤–æ–ª—ñ–≤.";
                 inputElement.value = userName;
             }
        };


        // --- –ó–∞–ø—É—Å–∫ ---
        window.onload = () => {
            initCanvas();
            initializeFirebase().then(() => {
                if (isHost) {
                    listenToBulletQueue();
                }
                draw();
            });

            // –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –∫–Ω–æ–ø–æ–∫ –¥–æ —Ñ—É–Ω–∫—Ü—ñ–π
            document.getElementById('create-game-btn').addEventListener('click', createGame);
            document.getElementById('join-game-btn').addEventListener('click', joinGame);
            document.getElementById('start-game-btn').addEventListener('click', startGame);
            document.getElementById('leave-game-btn').addEventListener('click', leaveGame);
            document.getElementById('user-name-input').addEventListener('blur', updateUserName);
            document.getElementById('user-name-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') updateUserName();
            });
            document.getElementById('ready-toggle-btn').addEventListener('click', toggleReady);
            document.getElementById('google-sign-in-btn').addEventListener('click', signInWithGoogle); // –ù–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ Google Sign-In
            document.getElementById('logout-btn').addEventListener('click', handleSignOut); // –ù–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ –í–∏—Ö–æ–¥—É

            const resizeCanvas = () => {
                const container = document.getElementById('canvas-container');
                const size = Math.min(container.clientWidth, window.innerHeight - 350);
                canvas.style.width = `${size}px`;
                canvas.style.height = `${size}px`;
            };
            window.addEventListener('resize', resizeCanvas);
            resizeCanvas();

        };
    </script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #1a202c; color: #e2e8f0; }
        #gameCanvas {
            background-color: #2d3748;
            border: 2px solid #4a5568;
            border-radius: 8px;
            box-shadow: 0 10px 15px rgba(0, 0, 0, 0.5);
            touch-action: none;
            max-width: 100%;
            height: auto;
        }
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 4px #1a202c;
            transform: translateY(0);
        }
        .btn:hover {
            opacity: 0.9;
            box-shadow: 0 6px #1a202c;
        }
        .btn:active {
            transform: translateY(4px);
            box-shadow: 0 0 #1a202c;
        }
        .btn-primary { background-color: #4c51bf; color: #fff; }
        .btn-secondary { background-color: #38a169; color: #fff; }
        .btn-danger { background-color: #e53e3e; color: #fff; }
        .btn-disabled { background-color: #a0aec0; color: #718096; cursor: not-allowed; box-shadow: none; transform: translateY(0); }
    </style>
</head>
<body class="p-4 md:p-8 flex flex-col items-center min-h-screen">

    <header class="w-full max-w-4xl mb-6">
        <h1 class="text-4xl font-extrabold text-indigo-400 text-center">–û—Ñ—ñ—Å–Ω–∏–π –ë—ñ–π: Mayhem üí•</h1>
        <p id="game-status" class="text-sm text-center text-gray-400 mt-2">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó...</p>
    </header>

    <main class="w-full max-w-4xl grid grid-cols-1 md:grid-cols-3 gap-6">

        <!-- –õ—ñ–≤–∞ –ü–∞–Ω–µ–ª—å: –°—Ç–∞—Ç—É—Å —Ç–∞ –õ–æ–±—ñ -->
        <div class="md:col-span-1 space-y-4">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-xl font-bold text-indigo-300 mb-2">–ú—ñ–π –°—Ç–∞—Ç—É—Å</h2>
                <p id="auth-status" class="text-sm text-red-400 mb-2">–ù–µ —É–≤—ñ–π—à–æ–≤.</p>
                <div class="flex items-center justify-between text-lg">
                    <span>HP:</span>
                    <span id="my-hp" class="font-mono text-green-400">100</span>
                </div>
                <div class="w-full bg-gray-600 rounded-full h-2.5 mt-1">
                    <div id="my-hp-bar" class="h-2.5 rounded-full" style="width: 100%; background-color: #48bb78;"></div>
                </div>
                <div class="flex items-center justify-between mt-2 text-lg">
                    <span>–†–∞—Ö—É–Ω–æ–∫:</span>
                    <span id="my-score" class="font-mono text-yellow-400">0</span>
                </div>
                <div class="text-xs text-gray-500 mt-2">
                    –ö—ñ–º–Ω–∞—Ç–∞: <span id="room-id-display" class="font-mono text-sm"> ‚Äî </span>
                    <br>
                    <span id="user-id-display" class="font-mono text-xs hidden"></span>
                </div>
            </div>

            <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –∞–≤—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é -->
            <div id="auth-controls" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3">
                 <button id="google-sign-in-btn" class="btn w-full flex items-center justify-center bg-white text-gray-800 hover:bg-gray-200">
                    <svg class="w-5 h-5 mr-2" viewBox="0 0 24 24" fill="currentColor">
                        <path d="M12.0003 4.6062C14.7937 4.6062 16.7118 5.766 17.6569 6.6713L20.301 3.999C18.6833 2.508 16.2979 1.666 12.0003 1.666C7.05267 1.666 2.76672 3.5262 0.817383 6.6475V6.6479H8.79092C9.28912 6.6479 9.69971 7.05849 9.69971 7.55669C9.69971 8.05489 9.28912 8.46548 8.79092 8.46548H2.89966C2.39958 10.3258 2.39958 12.6074 2.89966 14.4678H8.79092C9.28912 14.4678 9.69971 14.8784 9.69971 15.3766C9.69971 15.8748 9.28912 16.2854 8.79092 16.2854H0.817383C2.76672 19.4067 7.05267 21.267 12.0003 21.267C16.2979 21.267 18.6833 20.425 20.301 18.934L17.6569 16.2618C16.7118 17.1671 14.7937 18.3269 12.0003 18.3269C9.09635 18.3269 6.55174 17.068 5.09347 15.1508C5.0768 15.1091 5.05193 15.0601 5.03478 15.0205C5.01831 14.9808 5.00003 14.9412 4.98687 14.9015C4.8465 14.5447 4.80003 14.0772 4.80003 13.5668C4.80003 13.0564 4.8465 12.5889 4.98687 12.2321C5.00003 12.1924 5.01831 12.1528 5.03478 12.1132C5.05193 12.0735 5.0768 12.0245 5.09347 11.9828C6.55174 10.0656 9.09635 8.80669 12.0003 8.80669C13.8863 8.80669 15.1963 9.49721 16.0968 10.3662L17.7537 8.65349C16.4805 7.42062 14.6648 6.6479 12.0003 6.6479C9.28912 6.6479 7.05267 7.6439 5.86794 9.1724C5.86794 9.1724 5.86794 9.1724 5.86794 9.1724C5.86794 9.1724 5.86794 9.1724 5.86794 9.1724C5.86794 9.1724 5.86794 9.1724 5.86794 9.1724C5.86794 9.1724 5.86794 9.1724 5.86794 9.1724C5.86794 9.1724 5.86794 9.1724 5.86794 9.1724Z" fill="currentColor"/>
                    </svg>
                    –£–≤—ñ–π—Ç–∏ —á–µ—Ä–µ–∑ Google
                 </button>
            </div>
             <button id="logout-btn" class="btn btn-danger w-full hidden">
                –í–∏–π—Ç–∏ –∑ –ü—Ä–æ—Ñ—ñ–ª—é
            </button>


            <!-- –í–≤–µ–¥–µ–Ω–Ω—è –Ü–º–µ–Ω—ñ -->
            <div id="name-entry" class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <label for="user-name-input" class="block text-sm font-medium text-gray-300 mb-2">–í–∞—à–µ –Ü–≥—Ä–æ–≤–µ –Ü–º'—è (–¥–æ 15 —Å–∏–º–≤.):</label>
                <input type="text" id="user-name-input" class="w-full p-2 rounded bg-gray-700 border border-gray-600 focus:ring-indigo-500 focus:border-indigo-500 text-white" maxlength="15" value="AnonymousPlayer">
            </div>

            <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –õ–æ–±—ñ -->
            <div id="lobby-controls" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3">
                <button id="create-game-btn" class="btn btn-secondary w-full">
                    –°—Ç–≤–æ—Ä–∏—Ç–∏ –ù–æ–≤—É –ì—Ä—É
                </button>
                <!-- –§–Ü–ö–°: –ë—ñ–ª—å—à –∫–æ–Ω—Ç—Ä–æ–ª—å–æ–≤–∞–Ω–∞ —à–∏—Ä–∏–Ω–∞ –¥–ª—è input/button -->
                <div class="flex space-x-2 w-full">
                    <input type="text" id="join-room-id" placeholder="ID –∫—ñ–º–Ω–∞—Ç–∏" class="w-3/5 p-2 rounded bg-gray-700 border border-gray-600 text-white text-center" maxlength="8">
                    <button id="join-game-btn" class="btn btn-primary w-2/5">
                        –ü—Ä–∏—î–¥–Ω–∞—Ç–∏—Å—è
                    </button>
                </div>
            </div>

            <!-- –ö–µ—Ä—É–≤–∞–Ω–Ω—è –ì—Ä–æ—é -->
            <div id="game-controls" class="bg-gray-800 p-4 rounded-xl shadow-lg space-y-3 hidden">
                <button id="ready-toggle-btn" class="btn btn-secondary w-full">
                    –ì–æ—Ç–æ–≤–∏–π (–ù–µ–º–∞—î)
                </button>
                <button id="start-game-btn" class="btn btn-primary w-full hidden" disabled>
                    –ì–æ—Ç–æ–≤—ñ: 0/0 (–ü–æ—Ç—Ä—ñ–±–Ω–æ ‚â•2)
                </button>
                <button id="leave-game-btn" class="btn btn-danger w-full hidden">
                    –í–∏–π—Ç–∏ –∑ –ì—Ä–∏
                </button>
            </div>

             <!-- –Ü–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-sm">
                <h3 class="font-bold text-gray-300 mb-2">–Ø–∫ –ì—Ä–∞—Ç–∏:</h3>
                <ul class="list-disc list-inside space-y-1 text-gray-400">
                    <li>üïπÔ∏è **–†—É—Ö:** **WASD** –∞–±–æ **–°—Ç—Ä—ñ–ª–∫–∏** (–ù–∞ –º–æ–±—ñ–ª—å–Ω–æ–º—É: –ª—ñ–≤–∏–π –Ω–∏–∂–Ω—ñ–π –∫—É—Ç).</li>
                    <li>üí• **–°—Ç—Ä—ñ–ª—å–±–∞:** **–ö–ª—ñ–∫ –º–∏—à—ñ** –∞–±–æ **–î–æ—Ç–∏–∫** (–∑–∞ –º–µ–∂–∞–º–∏ –∑–æ–Ω–∏ –¥–∂–æ–π—Å—Ç–∏–∫–∞).</li>
                    <li>üí∞ **–û—á–∫–∏:** –ó–±–∏—Ä–∞–π—Ç–µ –º–æ–Ω–µ—Ç–∏ (+5) —Ç–∞ –≤–±–∏–≤–∞–π—Ç–µ —Å—É–ø–µ—Ä–Ω–∏–∫—ñ–≤ (+10).</li>
                    <li>üõ°Ô∏è **–°—Ç—ñ–Ω–∏:** –ü–µ—Ä–µ—à–∫–æ–¥–∏ –±–ª–æ–∫—É—é—Ç—å —Ä—É—Ö —ñ –ø–æ—Å—Ç—Ä—ñ–ª–∏.</li>
                </ul>
            </div>
        </div>

        <!-- –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞ –ü–∞–Ω–µ–ª—å: –Ü–≥—Ä–æ–≤–µ –ü–æ–ª–æ—Ç–Ω–æ -->
        <div id="canvas-container" class="md:col-span-2 flex justify-center items-center min-h-[400px]">
            <canvas id="gameCanvas" class="w-full aspect-square"></canvas>
        </div>

        <!-- –ü—Ä–∞–≤–∞ –ü–∞–Ω–µ–ª—å: –¢–∞–±–ª–∏—Ü—è –õ—ñ–¥–µ—Ä—ñ–≤ -->
        <div class="md:col-span-3 lg:col-span-1">
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <div class="flex justify-between items-center mb-4">
                    <h2 class="text-xl font-bold text-yellow-400">–¢–∞–±–ª–æ –õ—ñ–¥–µ—Ä—ñ–≤</h2>
                    <div class="text-lg font-mono text-red-400">
                        <span id="timer-display">01:30</span>
                    </div>
                </div>
                <ul id="leaderboard" class="space-y-2">
                    <li class="text-gray-500 text-center p-4">–£–≤—ñ–π–¥—ñ—Ç—å —Ç–∞ –ø—Ä–∏—î–¥–Ω–∞–π—Ç–µ—Å—å –¥–æ –≥—Ä–∏.</li>
                </ul>
            </div>
        </div>
    </main>

    <footer class="mt-8 text-xs text-gray-500 text-center">
        Office Mayhem (v1.3) | –ü–æ—Å—Ç—ñ–π–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ —á–µ—Ä–µ–∑ Google Sign-In —Ç–∞ Google Firestore.
    </footer>
</body>
</html>